<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Portfolio Manager</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- Bootstrap 3.3.2 -->
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- Font Awesome Icons -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Ionicons -->
    <link href="http://code.ionicframework.com/ionicons/2.0.0/css/ionicons.min.css" rel="stylesheet" type="text/css" />
    <!-- Theme style -->
    <link href="/static/dist/css/AdminLTE2.min.css" rel="stylesheet" type="text/css" />
    <link href="/static/dist/css/skins/skin-blue.min.css" rel="stylesheet" type="text/css" />

  </head>
  <body class="skin-blue" data-spy="scroll" data-target="#scrollspy">
    <div class="wrapper">

      <header class="main-header">

        <nav class="navbar navbar-static-top" role="navigation">
            <a href="/" class="logo"><b>Add</b>Transaction</a>

          <div class="navbar-custom-menu" style="display: flex; align-items: center; height: 100%; padding-top: 10px;"> <!-- 상단 여백 추가 -->
            <ul class="nav navbar-nav" style="display: flex; justify-content: center; margin: auto;">
                <li style="margin-right: 10px;"><button id="AddBtn" class="btn btn-primary">Add</button></li>
                <li><button id="closeButton" type="button" class="btn btn-warning">Close</button></li>
            </ul>
          </div>
        </nav>
      </header>

      <div class="content-wrapper">

        <!-- Content Header (Page header) -->

        <div class="content body" id="transactionDetails">
          <table class="table table-centered">
              <tbody>
                <tr>
                  <td><label for="target" class="label-width">Target:</label><br>
                    <button id="selectTargetBtn" class="btn btn-default btn-sm">Search</button>
                  </td>
                  <td>
                    <p id="target"></p>(<small id="targetId"></small>)
                  </td>
                </tr>
                <tr>
                  <td><label for="counterparty" class="label-width">counterparty:</label><br>
                    <button id="selectcounterpartyBtn" class="btn btn-default btn-sm">Search</button>
                  </td>
                  <td>
                    <p id="counterparty"></p>(<small id="counterpartyId"></small>)
                  </td>
                </tr>
                <tr>
                  <td><label for="fundName" class="label-width">Fund Name:</label><br>
                    <button id="selectfundBtn" class="btn btn-default btn-sm">Search</button>
                  </td>
                  <td><p id="fundName"></p>
                    (<small id="fundId"></small>)</td>
                </tr>
                <tr>
                  <td><label for="trsType" class="label-width">Transaction Type:</label></td>
                  <td>
                    <select id="trsType" class="form-control">
                      <option value="buy">Buy</option>
                      <option value="sell">Sell</option>
                      <option value="redeem">Redeem</option>
                      <option value="interest">Interest</option>
                      <option value="convert">Convert</option>
                      <option value="warrant" selected>Exercise Warrants</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td><label for="securityType" class="label-width">Security Type:</label></td>
                  <td>
                    <select id="securityType" class="form-control">
                      <option value="cs" selected>Common Stock</option>
                      <option value="cps">Convertible Preferred Stock</option>
                      <option value="rcps">RCPS</option>
                      <option value="cb">Convertible Bond</option>
                      <option value="bw">Bond with Warrant</option>
                      <option value="eb">Exchangeable Bond</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td><label for="currency" class="label-width">Currency:</label></td>
                  <td>
                    <select id="currency" class="form-control">
                      <option value="KRW" selected>KRW</option>
                      <option value="USD">USD</option>
                      <option value="EUR">EUR</option>
                      <option value="JPY">JPY</option>
                      <option value="CNY">CNY</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td><label for="unit" class="label-width">Unit:</label></td>
                  <td><select id="unit" class="form-control">
                    <option value="one" selected>One</option>
                    <option value="thousand">Thousand</option>
                    <option value="million">Million</option>
                    <option value="billion">Billion</option>
                    <option value="trillion">Trillion</option>
                  </select></td>
                </tr>
                <tr>
                  <td><label for="amount" class="label-width">Amount:</label></td>
                  <td><input type="number" id="amount" class="form-control" required></td>
                </tr>
                <tr>
                  <td><label for="prevalue" class="label-width">Pre-money valuation:</label></td>
                  <td><input type="number" id="prevalue" class="form-control" required></td>
                </tr>
                <tr>
                  <td><label for="trsDate" class="label-width">Transaction Date:</label></td>
                  <td><input type="date" id="trsDate" class="form-control" required></td>
                </tr>
                <tr>
                  <td><label for="terms" class="label-width">Terms:</label>
                    <button id="addTermBtn" class="btn btn-success btn-sm" style="margin-left: 10px;">+</button>
                  </td>
                  <td colspan="3">
                      <table id="termsGrid" class="table table-bordered">
                          <thead>
                              <tr>
                                  <th>Key</th>
                                  <th>Value</th>
                              </tr>
                          </thead>
                          <tbody id="termsBody">
                              <!-- JSON 데이터가 여기에 동적으로 추가됩니다. -->
                          </tbody>
                      </table>
                      
                  </td>
                </tr>
                <tr>
                  <td><label for="contributors" class="label-width">Contributors:</label>
                    <button id="addContributorBtn" class="btn btn-success btn-sm" style="margin-left: 10px;">+</button>
                  </td>
                  <td colspan="3">
                      <table id="contributorGrid" class="table table-bordered">
                          <thead>
                              <tr>
                                  <th hidden>ID</th>
                                  <th>Name</th>
                                  <th>Sourcing</th>
                                  <th>Reviewing</th>
                                  <th>Managing</th>
                              </tr>
                          </thead>
                          <tbody id="contributorBody">
                              <!-- JSON 데이터가 여기에 동적으로 추가됩니다. -->
                          </tbody>
                      </table>
                      
                  </td>
                </tr>
                <tr>
                    <td><label for="notes" class="label-width">Notes:</label></td>
                    <td><textarea id="notes" rows="10" style="width: 100%;"></textarea></td>
                </tr>
                
              </tbody>
          </table>
        </div>

      </div>
      
      <footer class="main-footer">
        <div class="pull-right hidden-xs">
          <b>Version</b> 2.0
        </div>
        <strong>Copyright &copy; 2014-2015 Ylem invest.</strong> All rights reserved.
      </footer>

    </div>

    <div id="searchModal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title">Search Results</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body">
                <input type="text" id="searchInput" class="form-control" placeholder="Enter search keyword" />
                <div id="results" style="margin-top: 10px;"></div>
            </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
    </div>

    <!-- jQuery 2.1.3 -->
    <script src="/static/plugins/jQuery/jQuery-2.1.3.min.js"></script>
    <!-- Bootstrap 3.3.2 JS -->
    <script src="/static/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <!-- FastClick -->
    <script src='/static/plugins/fastclick/fastclick.min.js'></script>
    <!-- AdminLTE App -->
    <script src="/static/dist/js/app.min.js" type="text/javascript"></script>
    <!-- SlimScroll 1.3.0 -->
    <script src="/static/plugins/slimScroll/jquery.slimscroll.min.js" type="text/javascript"></script>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <script>
      let securitiesData = [];
      $(document).ready(function() {
        let searchMode = '';

        $.ajax({
            url: '/getSecurities',
            method: 'GET',
            success: function(response) {
                if (response.status === 'success') {
                    securitiesData = response.data; // 전역 변수에 데이터 저장
                } else {
                    alert('Error loading securities: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred: ' + error);
            }
        });

        $('#trsType, #securityType').change(function() {

            const selectedTrsType = $('#trsType').val();
            const selectedSecurityType = $('#securityType').val();

            // terms 초기화
            $('#termsBody').empty();

            // securitiesData에서 terms 찾기
            const matchedSecurities = securitiesData.filter(security => 
                security.trs_type === selectedTrsType && security.type === selectedSecurityType
            );

            console.log(matchedSecurities);
            // terms가 있는 경우 표시
            if (matchedSecurities.length > 0) {
                const terms = matchedSecurities[0].terms; // 첫 번째 일치하는 보안의 terms 가져오기
                for (const key in terms) {
                    $('#termsBody').append(`
                        <tr>
                            <td><input type="text" class="form-control" value="${key}" readonly></td>
                            <td><input type="text" class="form-control" value="${terms[key]}"></td>
                            <td><button class="btn btn-danger btn-sm removeTermBtn">-</button></td>
                        </tr>
                    `);
                }
            }
        });

        $('#addTermBtn').click(function() {
            $('#termsBody').append(`
                <tr>
                    <td><input type="text" class="form-control" placeholder="Enter key"></td>
                    <td><input type="text" class="form-control" placeholder="Enter value"></td>
                    <td><button class="btn btn-danger btn-sm removeTermBtn">-</button></td>
                </tr>
            `);
        });

        $(document).on('click', '.removeTermBtn', function() {
            $(this).closest('tr').remove(); // 해당 행 삭제
        });

        $('#addContributorBtn').click(function() {
            $('#contributorBody').append(`
                <tr>
                    <td><button id="selectUserBtn" class="btn btn-default btn-sm">Name</button></td>
                    <td><input type="number" class="form-control" placeholder="%"></td>
                    <td><input type="number" class="form-control" placeholder="%"></td>
                    <td><input type="number" class="form-control" placeholder="%"></td>
                    <td><button class="btn btn-danger btn-sm removeContriBtn">-</button></td>
                </tr>
            `);
        });

        $(document).on('click', '.removeContriBtn', function() {
            $(this).closest('tr').remove(); // 해당 행 삭제
        });

        $(document).on('click', '.result-item', function() {
            const selectedId = $(this).data('id'); 
            const selectedName = $(this).text(); 
            $('#results').empty();
            $("#searchModal").modal("hide");
            if (searchMode == 'fund') {
                $('#fundId').text(selectedId);
                $('#fundName').text(selectedName);
              } else if (searchMode == 'counterparty') {
                $('#counterpartyId').text(selectedId);
                $('#counterparty').text(selectedName);
              } else if (searchMode == 'target') {
                $('#targetId').text(selectedId);
                $('#target').text(selectedName);
              } 

        });

        $('#AddBtn').click(function() {
          const updatedData = {
              fund_id: $('#fundId').text(),
              counterparty_id: $('#counterpartyId').text(),
              target_id: $('#targetId').text(),
              trs_type: $('#trsType').val(),
              security_type: $('#securityType').val(),
              currency: $('#currency').val(),
              unit: $('#unit').val(),
              prevalue: $('#prevalue').val(),
              amount: $('#amount').val(),
              trs_date: $('#trsDate').val(),
              notes: $('#notes').val(),
              terms: {},
              contributors: []
          };

          if (!updatedData.fund_id || !updatedData.counterparty_id || !updatedData.target_id || 
              !updatedData.trs_type || !updatedData.security_type || 
              !updatedData.currency || !updatedData.unit || !updatedData.prevalue ||
              !updatedData.amount || !updatedData.trs_date) {
              alert('Please fill in all required fields except for Terms and Notes.');
              return; // 필수 값이 없으면 진행하지 않음
          }

          $('#termsBody tr').each(function() {
              const key = $(this).find('input').eq(0).val();
              const value = $(this).find('input').eq(1).val();
              updatedData.terms[key] = value;
          });

          $('#contributorBody tr').each(function() {
              const userId = $(this).find('p').attr('data-id');
              const name = $(this).find('p').text(); 
              const contributorData = {
                  userId: userId,
                  name: name,
                  sourcing: $(this).find('input').eq(0).val(), // 첫 번째 입력 필드 값
                  dd: $(this).find('input').eq(1).val(), // 두 번째 입력 필드 값
                  pim: $(this).find('input').eq(2).val() // 세 번째 입력 필드 값
              };
              
              updatedData.contributors.push(contributorData); // contributors 배열에 추가
          });

          $.ajax({
              url: `/addTransaction`, // 서버의 업데이트 엔드포인트
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(updatedData),
              success: function(response) {
                  if (response.status === 'success') {
                      alert('Transaction updated successfully!');
                      window.location.href = '/transactions';
                  } else {
                      alert('Error updating transaction: ' + response.message);
                  }
              },
              error: function(xhr, status, error) {
                  alert('An error occurred: ' + error);
              }
          });
        });

        $('#closeButton').click(function() {
          window.location.href ='/transactions'; 
        });

        $('#selectfundBtn').click(function() {
          $('#results').empty();
          $("#searchModal").modal("show");
          searchMode = 'fund';
        });

        $('#selectcounterpartyBtn').click(function() {
          $('#results').empty();
          $("#searchModal").modal("show");
          searchMode = 'counterparty';
        });

        $('#selectTargetBtn').click(function() {
          $('#results').empty();
          $("#searchModal").modal("show");
          searchMode = 'target';
        });

        $('#contributorBody').on('click', '#selectUserBtn', function() {
          const row = $(this).closest('tr');
          $('#results').empty();
          $("#searchModal").modal("show");
          searchMode = 'user';
          $(document).on('click', '.result-item', function() {
              handleUserSelection(row, $(this).data('id'), $(this).text());
          });
        });

        $('#searchInput').on('keypress', async function(event) {
          if (event.which === 13) { 
            const searchTerm = $(this).val(); 
            $(this).val('');
            await searchKeyword (searchTerm, searchMode);
          }
        });

        async function searchKeyword(keyword, searchMode){
          let targetURL = '';
          if (searchMode == 'fund') {
            targetURL = '/searchFund';
          } else if (searchMode == 'counterparty' || searchMode == 'target') {
            targetURL = '/searchCompany';
          } else if (searchMode == 'user') {
            targetURL = '/searchUser';
          } else {
            alert("No search Mode");
            return;
          }
          
          if (keyword) {
            $.get(`${targetURL}?query=${keyword}`, function(response) {
              if (response.status === 'success' && response.data.length > 0) {
                console.log(response.data);
                $('#results').empty();
                if (searchMode == 'fund') {
                  response.data.forEach(function(item) {
                    $('#results').append(`
                      <div style="padding: 5px; cursor: pointer;" class="result-item" data-id="${item._id}">
                        ${item.fundName}
                      </div>
                    `);
                  });
                } else if (searchMode == 'counterparty' || searchMode == 'target') {
                    response.data.forEach(function(item) {
                    $('#results').append(`
                      <div style="padding: 5px; cursor: pointer;" class="result-item" data-id="${item._id}">
                        ${item.companyName}
                      </div>
                    `);
                  });
                } else if (searchMode == 'user') {
                  response.data.forEach(function(item) {
                    $('#results').append(`
                      <div style="padding: 5px; cursor: pointer;" class="result-item" data-id="${item._id}">
                        ${item.name}
                      </div>
                    `);
                  });
                }

              } else {
                alert('No results found.');
              }
            });
          } else {
            alert('No keyword');
          }
        }

        function handleUserSelection(row, selectedId, selectedName) {
            $("#searchModal").modal("hide");

            row.find('#selectUserBtn').remove(); 
            const inputField = `<p data-id="${selectedId}">${selectedName}</p>`;
            row.find('td:first-child').append(inputField);
        }

        function populateTermsGrid(data) {
            const termsBody = $('#termsBody');
            termsBody.empty(); // 기존 내용 삭제
            for (const key in data) {
                termsBody.append(`
                    <tr>
                        <td><input type="text" class="form-control" value="${key}" readonly></td>
                        <td><input type="text" class="form-control" value="${data[key]}"></td>
                        <td><button class="btn btn-danger btn-sm removeTermBtn">-</button></td>
                    </tr>
                `);
            }
        }


      });
  </script>
  </body>
</html>