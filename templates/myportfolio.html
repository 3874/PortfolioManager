<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Portfolio Manager</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- Bootstrap 3.3.2 -->
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- Font Awesome Icons -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Ionicons -->
    <link href="http://code.ionicframework.com/ionicons/2.0.0/css/ionicons.min.css" rel="stylesheet" type="text/css" />
    <!-- Theme style -->
    <link href="/static/dist/css/AdminLTE2.min.css" rel="stylesheet" type="text/css" />
    <link href="/static/dist/css/skins/skin-blue.min.css" rel="stylesheet" type="text/css" />


  </head>
  <body class="skin-blue fixed" data-spy="scroll" data-target="#scrollspy">
    <div class="wrapper">

      <header class="main-header">

        <nav class="navbar navbar-static-top" role="navigation">
            <a href="/" class="logo"><b>My</b>Portfolio</a>            
            <div class="navbar-custom-menu" style="display: flex; align-items: center; height: 100%; padding-top: 10px;"> 
              <ul class="nav navbar-nav" style="display: flex; justify-content: center; margin: auto;">               
                  <li><button id="closeButton" type="button" class="btn btn-warning">Close</button></li>
              </ul>
            </div>
        </nav>
      </header>

      <div class="content-wrapper">

        <div class="content body" id="transactionDetails">

          <table class="table table-centered">
              <tbody>
                  <tr>
                      <td><label for="transactionId" class="label-width">Transaction ID:</label></td>
                      <td><p id="transactionId" readonly></p></td>
                  </tr>

                  <tr>
                    <td><label for="fundName" class="label-width">Fund Name:</label><br>
                    </td>
                    <td><p id="fundName"></p>
                      (<small id="fundId"></small>)</td>
                  </tr>
                  <tr>
                    <td><label for="counterparty" class="label-width">Counterparty:</label><br>
                    </td>
                    <td>
                      <p id="counterparty"></p>(<small id="counterpartyId"></small>)
                    </td>

                  </tr>
                  <tr>
                    <td><label for="target" class="label-width">Target:</label><br>
                    </td>
                    <td>
                      <p id="target"></p>(<small id="targetId"></small>)
                    </td>
                  </tr>
                  <tr>
                    <td><label for="trsType" class="label-width">Transaction Type:</label></td>
                    <td><input type="text" id="trsType" class="form-control" value="" readonly/></td>

                  </tr>
                  <tr>
                    <td><label for="securityType" class="label-width">Security Type:</label></td>
                    <td><input type="text" id="securityType" class="form-control" value="" readonly/></td>
                  </tr>
                  <tr>
                    <td><label for="offering" class="label-width">Offering:</label></td>
                    <td><input type="text" id="offering" class="form-control" value="" readonly/></td>
                  </tr>
                  <tr>
                    <td><label for="currency" class="label-width">Currency:</label></td>
                    <td><input type="text" id="currency" class="form-control" readonly /></td>
                  </tr>
                  <tr>
                    <td><label for="amount" class="label-width">Amount:</label></td>
                    <td><input type="number" id="amount" class="form-control" value="" readonly /></td>
                  </tr>
                  <tr>
                    <td><label for="prevalue" class="label-width">Pre-money Valuation:</label></td>
                    <td><input type="number" id="prevalue" class="form-control" value="" readonly /></td>
                  </tr>
                  <tr>
                    <td><label for="trsDate" class="label-width">Transaction Date:</label></td>
                    <td><input type="date" id="trsDate" class="form-control" value="" readonly /></td>
                  </tr>
                  <tr>
                    <td><label for="terms" class="label-width">Terms:</label>
                    </td>
                    <td colspan="3">
                        <table id="termsGrid" class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="termsBody">
                                <!-- JSON 데이터가 여기에 동적으로 추가됩니다. -->
                            </tbody>
                        </table>
                        
                    </td>
                  </tr>
                  <tr id="contributorsRow">
                    <td><label for="contributors" class="label-width">Contributors:</label>
                    </td>
                    <td colspan="3">
                        <table id="contributorGrid" class="table table-bordered">
                            <thead>
                                <tr>
                                    <th hidden>ID</th>
                                    <th>Name</th>
                                    <th>Sourcing</th>
                                    <th>Reviewing</th>
                                    <th>Managing</th>
                                </tr>
                            </thead>
                            <tbody id="contributorBody">
                                <!-- JSON 데이터가 여기에 동적으로 추가됩니다. -->
                            </tbody>
                        </table>
                    </td>
                  </tr>
                  <tr>
                    <td><label for="transactionTable" class="label-width">Transactions:</label>
                    </td>
                    <td>
                      <table id="transactionTable" class="table table-bordered table-hover">
                          <thead>
                            <tr>
                              <th>No</th>
                              <th>Date</th>
                              <th>Transaction</th>
                              <th>No. of Shares</th>
                              <th>Price/Share</th>
                              <th>Amount</th>
                            </tr>
                          </thead>
                          <tbody>

                          </tbody>
                      </table>
                    </td>
                  </tr>
                  <tr>
                      <td><label for="notes" class="label-width">Notes:</label></td>
                      <td><textarea id="notes" rows="10" style="width: 100%;" readonly></textarea></td>
                  </tr>
                  <tr>
                    <td><label for="createdBy" class="label-width">Created By:</label></td>
                    <td><p id="createdBy"></p></td>
                  </tr>
                  <tr>
                      <td><label for="createdAt" class="label-width">Created At:</label></td>
                      <td><p id="createdAt"></p></td>
                  </tr>
                  <tr>
                      <td><label for="updatedAt" class="label-width">Updated At:</label></td>
                      <td><p id="updatedAt"></p></td>
                  </tr>
              </tbody>
          </table>
        </div>

      </div>
      
      <footer class="main-footer">
        <div class="pull-right hidden-xs">
          <b>Version</b> 2.0
        </div>
        <strong>Copyright &copy; 2014-2015 <a href="https://yleminvest.com">Ylem Invest</a>.</strong> All rights reserved.
      </footer>

    </div>

    <div class="modal fade" id="transactionModal" tabindex="-1" role="dialog" aria-labelledby="transactionModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="transactionModalLabel">Transaction Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="transactionForm">
              <div class="form-group" id="modal_no_div">
                <label for="modal_no">No</label>
                <input type="number" class="form-control" id="modal_no" readonly>
              </div>
              <div class="form-group">
                <label for="modal_date">Date</label>
                <input type="date" class="form-control" id="modal_date" required>
              </div>
              <div class="form-group">
                <label for="modal_transact">Transaction Type</label>
                <select class="form-control" id="modal_transact" required>
                  <option value="sell">Sell</option>
                  <option value="convert">Convert</option>
                  <option value="redeem">Redeem</option>
                  <option value="interest">Interest</option>
                  <option value="dividend">Dividend</option>
                  <option value="exercise">Exercise Warrants</option>
                  <option value="exchange">Exchange</option>
                  <option value="capReduct">Capital Reduct</option>
                </select>
              </div>
              <div class="form-group" >
                <label for="modal_no_of_share">Number of Shares</label>
                <input type="number" class="form-control" id="modal_no_of_share" required>
              </div>
              <div class="form-group">
                <label for="modal_price_per_share">Price per Share</label>
                <input type="number" class="form-control" id="modal_price_per_share" required>
              </div>
              <div class="form-group">
                <label for="modal_amount">Amount</label>
                <input type="number" class="form-control" id="modal_amount" required>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>


    <!-- jQuery 2.1.3 -->
    <script src="/static/plugins/jQuery/jQuery-2.1.3.min.js"></script>
    <!-- Bootstrap 3.3.2 JS -->
    <script src="/static/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <!-- FastClick -->
    <script src='/static/plugins/fastclick/fastclick.min.js'></script>
    <!-- AdminLTE App -->
    <script src="/static/dist/js/app.min.js" type="text/javascript"></script>
    <!-- SlimScroll 1.3.0 -->
    <script src="/static/plugins/slimScroll/jquery.slimscroll.min.js" type="text/javascript"></script>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <script>
      $(document).ready(function() {
        let searchMode = '';
        let transactionData = [];

        let investmentId = localStorage.getItem("PMinvestmentId");
        $.ajax({
            url: `/getInvestment/${investmentId}`, 
            method: 'GET',
            success: function(response) {
                if (response.status === 'success') {
                  console.log(response);
                  dataMapping(response.data);
                } else {
                  console.error('투자 정보 가져오기 실패:', response.message);
                }
            },
            error: function(xhr, error, code) {
                console.error('서버 요청 실패:', error);
            }
        });


        $('#closeButton').click(function() {
          window.history.back();
        });


        function populateTermsGrid(data) {
            const termsBody = $('#termsBody');
            termsBody.empty(); // 기존 내용 삭제
            for (const key in data) {
                termsBody.append(`
                    <tr>
                        <td><input type="text" class="form-control" value="${key}" readonly></td>
                        <td><input type="text" class="form-control" value="${data[key]}" readonly></td>
                    </tr>
                `);
            }
        }

        function handleUserSelection(row, selectedId, selectedName) {
            $("#searchModal").modal("hide");
            row.find('#selectUserBtn').remove(); 
            const inputField = `<p data-id="${selectedId}">${selectedName}</p>`;
            row.find('td:first-child').append(inputField);
        }
        
        function dataMapping(info) {
          const investmentData = info;
          const tableBody = $('#transactionTable tbody');
          tableBody.empty();

          let dateObject = new Date(investmentData.trs_date);
          function formatDate(date) {
              let year = date.getFullYear();
              let month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
              let day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`; // 'YYYY-MM-DD' 형식
          }
          $('#trsDate').val(formatDate(dateObject));
          $('#transactionId').text(investmentData._id);
          $('#targetId').text(investmentData.target_id);
          $('#prevalue').val(investmentData.prevalue);
          $('#offering').val(investmentData.offering);
          $('#counterpartyId').text(investmentData.counterparty_id);
          $('#target').text(investmentData.target);
          $('#amount').val(investmentData.amount);
          $('#trsType').val(investmentData.trs_type);
          $('#securityType').val(investmentData.security_type);
          $('#currency').val(investmentData.currency);
          $('#fundId').text(investmentData.fund_id);
          $('#fundName').text(investmentData.fundName);
          $('#counterparty').text(investmentData.counterparty);
          $('#createdBy').text(investmentData.createdBy);
          $('#createdAt').text(investmentData.createdAt);
          $('#updatedAt').text(investmentData.updatedAt);
          $('#notes').val(investmentData.notes);
          populateTermsGrid(investmentData.terms);
          if (investmentData.contributors && investmentData.contributors.length > 0) {
                investmentData.contributors.forEach(contributor => {
                    $('#contributorBody').append(`
                        <tr>
                            <td><p data-id="${contributor.userId}">${contributor.name}</p></td>
                            <td><input type="number" class="form-control" value="${contributor.sourcing}" readonly></td>
                            <td><input type="number" class="form-control" value="${contributor.dd}" readonly></td>
                            <td><input type="number" class="form-control" value="${contributor.pim}" readonly></td>
                            
                        </tr>
                    `);
                });
            }

          let transact = investmentData.transactions;

          if (transact !== undefined &&  transact !== '') {
            transact.forEach(function(transaction, index) {
            const row = `
                <tr>
                  <td>${index + 1}</td>
                  <td>${transaction.date}</td>
                  <td>${transaction.transaction_type}</td>
                  <td>${transaction.no_of_share.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                  <td>${transaction.price_per_share.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                  <td>${transaction.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>

                </tr>
              `;
              tableBody.append(row);
            });
          }

        };

      });
  </script>
  </body>
</html>